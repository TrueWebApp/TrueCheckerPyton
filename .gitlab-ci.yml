stages:
  - test
  - release


linters:
  image: python:3.8-slim-buster
  stage: test
  script:
    - ls -l
    - pip install mypy flake8 black
    - mypy .
    - flake8 .
    - black --check .


pytest:
  stage: test
  image: python:3.8
  script:
    - pip install poetry
    - poetry export -E ultra -o requirements.txt --dev --without-hashes
    - pip install -r requirements.txt
    - pytest --cov=truechecker/ tests/
    - coverage xml
    - bash <(curl -s https://codecov.io/bash)
  artifacts:
    reports:
      cobertura: coverage.xml
  coverage: '/TOTAL\s+\d+\s+\d+\s+(\d+%)/'


pypi:
  image: python:3.8
  stage: release
  script:
    - pip install -U twine poetry
    - poetry build
    - poetry publish --username $TWINE_USERNAME --password $TWINE_PASSWORD
  only:
    - tags
